{% extends '_base.html' %}

{% block title %}
{% endblock %}

{% block content %}
<div>
    <h3>Welcome, {{ name }}</h3>
    <form class="form-horizontal" id="main-form" enctype=multipart/form-data role="form" method="post" action="/">
        <input type="hidden" name="count" value="1"/>
        {{ form.csrf_token }}
        {% for expense_item in form.items %}
            {{ expense_item.expense(placeholder="Expense Name", id="expense_0", value="") }}
            {{ expense_item.cost(placeholder="Cost", id="cost_0", class="cost", value="") }}
            {{ expense_item.due_date(id="due_date_0") }}
            {{ expense_item.desc(id="desc_0") }}
        {% endfor %}
        <button id="del_row_0" class="btn btn-secondary delete-row" type="button">-</button>
        <button class="btn btn-info add-more" type="button">+</button>
        <br id="br_0">
        <hr>
        <button class="submit-expenses" type="submit">Post Expense</button>
    </form>

    <div class="totals">
        <h3>TOTALS</h3>
        <table>
            <tr>
                <td><strong>Mutual Total</strong></td>
                <td class="amount mutual"></td>
            </tr>
            <tr>
                <td><strong>Per Person Total</strong></td>
                <td class="amount perperson"></td>
            </tr>
            <tr>
                <td><strong>Personal Paycheck #1</strong></td>
                <td class="amount paycheck1"></td>
            </tr>
            <tr>
                <td><strong>Personal Paycheck #2</strong></td>
                <td class="amount paycheck2"></td>
            </tr>
        </table>
    </div>
</div>
<div class="index-history">
    <h3>Historical Graph goes here !!!</h3>
<canvas id="chart"></canvas>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

<script>
var data = {{ expenses|tojson }};
var ctx = document.getElementById("chart").getContext('2d');

var MONTHS = ["January", "February", "March", "April", "May", "June"];

function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}


var config = {
    type: 'line',
    data: {
        datasets: [],
    },
  options: {
    responsive: true,
    title:{
      display:true,
      text:'1 Expense Graph'
    },
    tooltips: {
      mode: 'index',
      intersect: false,
    },
   hover: {
      mode: 'nearest',
      intersect: true
    },
    scales: {
      xAxes: [{
        display: true,
        scaleLabel: {
          display: true,
          labelString: 'Month'
        }
      }],
      yAxes: [{
        display: true,
        scaleLabel: {
          display: true,
        },
      }]
    }
  }
};
console.log(data);

var dates = []
var fields = []
var cost_per_field = {}

$.each(data, function(key, value){
    // Get Dates
    dates.push(key);
    $.each(value, function(k, v){
        fields.push(v['expense'])
    })
});

//Make a unique expense field
$.unique(fields.sort());

function check_value(value, field_name){
    var cost = 0;
    $.each(value, function(k, v){
        if(v.expense == field_name){
            cost = v.cost;
            return false;
        }
    })
    return cost;
}

// iterate over data per @field and get the @cost per date
$.each(fields, function(k, v){
    cost_per_field[v] = [];
    cost = 0;
    $.each(data, function(date, val){
        cost = check_value(val, v)
        if (cost != 0){
            cost_per_field[v].push(cost)
        }else{
            cost_per_field[v].push(0)
        }

    })
});


console.log('============');
console.log(cost_per_field);

config.data['labels'] = dates;
$.each(cost_per_field, function(key, value){
    console.log('a', key, value)
    color = getRandomColor();
    config.data.datasets.push({
        label: key,
        data: value,
        backgroundColor: color,
        borderColor: color,
        borderWidth: 3,
        fill: false
    })
});

var myLine = new Chart(ctx, config);

</script>
{% endblock %}
